<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Balloon Ground Station Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for map and responsive layout */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #1a1a2e; /* Deep purple background */
            color: #e0e0e0;
        }

        #map {
            flex-grow: 1; /* Map takes up remaining vertical space */
            height: 60vh; /* Default height for map */
            min-height: 300px;
            background-color: #333;
        }

        /* Responsive layout for main container */
        .main-container {
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .main-container {
                flex-direction: row;
                height: 100vh;
            }
            #map {
                height: 100vh;
                flex-grow: 3; /* Map takes more horizontal space */
            }
            #telemetry-panel {
                flex-shrink: 0;
                width: 380px; /* Fixed width for desktop sidebar */
                height: 100vh;
                overflow-y: auto;
            }
        }

        /* Overlay for connection status */
        #connection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.5s;
            border-radius: 0.5rem;
        }

        /* Signal bar styling */
        .signal-bar-container {
            height: 10px;
            background-color: #3f3f46; /* Tailwind gray-700 */
            border-radius: 9999px;
            overflow: hidden;
            width: 100%;
        }
        .signal-bar {
            height: 100%;
            transition: width 0.5s ease-out, background-color 0.5s ease-out;
        }
        .data-card {
            background-color: #2b2b45; /* Slightly lighter purple for cards */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #3d3d5c;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="main-container">
        <!-- Telemetry Panel (Sidebar on Desktop, Top/Bottom on Mobile) -->
        <div id="telemetry-panel" class="p-4 bg-gray-800 lg:p-6 shadow-2xl relative">
            <h1 class="text-3xl font-bold mb-6 text-indigo-400 border-b border-indigo-700 pb-2">Ground Station</h1>

            <!-- Connection Overlay (Displays until WebSocket connects) -->
            <div id="connection-overlay" class="rounded-lg">
                <div class="flex flex-col items-center">
                    <svg class="animate-spin h-8 w-8 text-indigo-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-lg font-medium" id="connection-status-text">Attempting to connect to bridge...</p>
                    <p class="text-sm text-gray-400 mt-2">ws://localhost:8080</p>
                </div>
            </div>

            <!-- Telemetry Data Cards -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Altitude Card -->
                <div class="data-card p-3 rounded-lg flex flex-col items-center">
                    <i data-lucide="cloud-lightning" class="w-6 h-6 text-blue-400 mb-1"></i>
                    <p class="text-sm text-gray-400">ALTITUDE</p>
                    <p id="data-alt" class="text-2xl font-extrabold text-blue-200">0 m</p>
                </div>
                <!-- Speed Card -->
                <div class="data-card p-3 rounded-lg flex flex-col items-center">
                    <i data-lucide="gauge" class="w-6 h-6 text-teal-400 mb-1"></i>
                    <p class="text-sm text-gray-400">SPEED</p>
                    <p id="data-speed" class="text-2xl font-extrabold text-teal-200">0 km/h</p>
                </div>
                <!-- Latitude Card -->
                <div class="data-card p-3 rounded-lg col-span-2">
                    <i data-lucide="map-pin" class="w-5 h-5 text-yellow-400 inline mr-2"></i>
                    <span class="text-sm text-gray-400">LOCATION (Lat/Lon)</span>
                    <p id="data-latlon" class="text-lg font-semibold text-yellow-200 truncate">7.8731 / 80.7718</p>
                </div>
            </div>

            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-3 text-red-400">Signal Status</h2>

                <!-- RSSI Card -->
                <div class="data-card p-3 rounded-lg mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">
                            <i data-lucide="signal" class="w-5 h-5 text-gray-400 mr-2"></i>
                            <span class="text-sm font-medium">RSSI (Signal Strength)</span>
                        </div>
                        <span id="data-rssi" class="text-lg font-bold text-red-200">-120 dBm</span>
                    </div>
                    <div class="signal-bar-container">
                        <div id="rssi-bar" class="signal-bar" style="width: 0%; background-color: #dc2626;"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Status: <span id="rssi-status" class="text-red-400 font-semibold">No Signal</span></p>
                </div>

                <!-- SNR Card -->
                <div class="data-card p-3 rounded-lg">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">
                            <i data-lucide="waves" class="w-5 h-5 text-gray-400 mr-2"></i>
                            <span class="text-sm font-medium">SNR (Signal-to-Noise)</span>
                        </div>
                        <span id="data-snr" class="text-lg font-bold text-green-200">0.0 dB</span>
                    </div>
                    <div class="signal-bar-container">
                        <div id="snr-bar" class="signal-bar" style="width: 0%; background-color: #10b981;"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Quality: <span id="snr-status" class="text-green-400 font-semibold">Poor</span></p>
                </div>
            </div>

            <!-- Last Update Footer -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <p class="text-xs text-gray-500">Last Packet Received:</p>
                <p id="last-update" class="text-sm font-medium text-gray-400">Awaiting data...</p>
            </div>
        </div>

        <!-- Map Area -->
        <div id="map-container" class="relative flex-grow">
            <div id="map" class="w-full h-full"></div>
        </div>

    </div>

    <!-- JavaScript for Map and WebSocket -->
    <script>
        // Global variables for Map and Marker
        let map;
        let balloonMarker;
        let socket;
        const INITIAL_LOCATION = { lat: 7.8731, lng: 80.7718 }; // Initial location (Sri Lanka)

        // --- MAP INITIALIZATION ---

        function initMap() {
            // Check if google.maps is loaded
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps API did not load.");
                document.getElementById('connection-status-text').textContent = "Map Error: Check API Key";
                return;
            }

            map = new google.maps.Map(document.getElementById('map'), {
                center: INITIAL_LOCATION,
                zoom: 10,
                mapTypeId: 'terrain', // Useful for viewing topography on a mission
                disableDefaultUI: true, // Clean map look
                zoomControl: true,
                scaleControl: true,
            });

            // Create a custom marker for the balloon
            balloonMarker = new google.maps.Marker({
                position: INITIAL_LOCATION,
                map: map,
                title: 'Weather Balloon Payload',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%20width%3D%2230%22%20height%3D%2230%22%20fill%3D%22%23ff6347%22%3E%3Cpath%20d%3D%22M12%202C6.48%202%202%206.48%202%2012s4.48%2010%2010%2010%2010-4.48%2010-10S17.52%202%2012%202zm0%2018c-3.31%200-6-2.69-6-6h2c0%202.21%201.79%204%204%204s4-1.79%204-4h2c0%203.31-2.69%206-6%206z%22%20fill%3D%22%23F59E0B%22%2F%3E%3Cpath%20d%3D%22M12%2012m-8%200a8%208%200%201%200%2016%200a8%208%200%201%200-16%200%22%20opacity%3D%220.2%22%2F%3E%3Cpath%20d%3D%22M12%208c-2.21%200-4%201.79-4%204h8c0-2.21-1.79-4-4-4z%22%20fill%3D%22%23EF4444%22%2F%3E%3C%2Fsvg%3E',
                    anchor: new google.maps.Point(15, 15) // Center the icon
                }
            });

            // Start the WebSocket connection after the map loads
            connectWebSocket();
        }

        // --- WEBSOCKET CONNECTION ---

        function connectWebSocket() {
            const statusText = document.getElementById('connection-status-text');
            const overlay = document.getElementById('connection-overlay');

            try {
                // Connect to the Python bridge server
                socket = new WebSocket('ws://localhost:8080');
                statusText.textContent = "Attempting to connect to bridge...";
                
                socket.onopen = () => {
                    console.log('WebSocket Connected.');
                    statusText.textContent = "CONNECTED";
                    // Hide the overlay after a moment
                    setTimeout(() => overlay.style.opacity = '0', 500);
                    setTimeout(() => overlay.style.display = 'none', 1000);
                };

                socket.onmessage = (event) => {
                    // Data received from Python bridge (a JSON string)
                    try {
                        const data = JSON.parse(event.data);
                        updateUI(data); // Update the map and panel
                    } catch (e) {
                        console.error("Error parsing JSON data:", e, event.data);
                    }
                };

                socket.onclose = (event) => {
                    console.warn('WebSocket Disconnected.', event);
                    overlay.style.display = 'flex';
                    overlay.style.opacity = '1';
                    statusText.textContent = `DISCONNECTED. Code: ${event.code}`;
                    // Attempt to reconnect after 5 seconds
                    setTimeout(connectWebSocket, 5000);
                };

                socket.onerror = (error) => {
                    console.error('WebSocket Error:', error);
                    statusText.textContent = "ERROR. Retrying...";
                };

            } catch (e) {
                console.error("Failed to initialize WebSocket:", e);
                statusText.textContent = "FATAL ERROR. Check Console.";
            }
        }

        // --- UI UPDATE LOGIC ---

        function updateUI(data) {
            // 1. Update Map Marker
            const newPosition = { lat: parseFloat(data.lat), lng: parseFloat(data.lon) };
            balloonMarker.setPosition(newPosition);
            map.panTo(newPosition); // Keep the balloon centered

            // 2. Update Telemetry Panel
            document.getElementById('data-latlon').textContent = `${data.lat.toFixed(6)} / ${data.lon.toFixed(6)}`;
            document.getElementById('data-alt').textContent = `${Math.round(data.alt).toLocaleString()} m`;
            document.getElementById('data-speed').textContent = `${data.speed.toFixed(1)} km/h`;
            document.getElementById('data-rssi').textContent = `${data.rssi} dBm`;
            document.getElementById('data-snr').textContent = `${data.snr.toFixed(1)} dB`;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

            // 3. Update Signal Status and Bars
            updateSignalIndicators(data.rssi, data.snr);

            // Re-render lucide icons after content update
            lucide.createIcons();
        }

        function updateSignalIndicators(rssi, snr) {
            // RSSI (Signal Strength) Logic
            const minRssi = -140; // Max weak signal
            const maxRssi = -40; // Max strong signal
            let rssiPercent = Math.min(100, Math.max(0, (rssi - minRssi) / (maxRssi - minRssi) * 100));

            // Set bar width and color based on RSSI
            const rssiBar = document.getElementById('rssi-bar');
            const rssiStatus = document.getElementById('rssi-status');
            rssiBar.style.width = `${rssiPercent}%`;

            let rssiColor = '#dc2626'; // Red (default)
            let statusText = 'No Signal';

            if (rssiPercent >= 75) {
                rssiColor = '#10b981'; // Green
                statusText = 'Excellent';
            } else if (rssiPercent >= 50) {
                rssiColor = '#f59e0b'; // Amber
                statusText = 'Good';
            } else if (rssiPercent >= 25) {
                rssiColor = '#f97316'; // Orange
                statusText = 'Fair';
            } else if (rssiPercent > 0) {
                rssiColor = '#dc2626'; // Red
                statusText = 'Poor';
            }

            rssiBar.style.backgroundColor = rssiColor;
            rssiStatus.textContent = statusText;
            rssiStatus.className = `text-[${rssiColor}] font-semibold`;


            // SNR (Signal-to-Noise Ratio) Logic
            const minSnr = -10; // Bad SNR
            const maxSnr = 15; // Good SNR
            let snrPercent = Math.min(100, Math.max(0, (snr - minSnr) / (maxSnr - minSnr) * 100));
            
            // Set bar width and color based on SNR
            const snrBar = document.getElementById('snr-bar');
            const snrStatus = document.getElementById('snr-status');
            snrBar.style.width = `${snrPercent}%`;
            
            let snrColor = '#dc2626'; // Red
            let snrStatusText = 'Very Poor';
            
            if (snrPercent >= 80) {
                snrColor = '#10b981'; // Green
                snrStatusText = 'Excellent';
            } else if (snrPercent >= 50) {
                snrColor = '#f59e0b'; // Amber
                snrStatusText = 'Good';
            } else if (snrPercent >= 20) {
                snrColor = '#f97316'; // Orange
                snrStatusText = 'Fair';
            }

            snrBar.style.backgroundColor = snrColor;
            snrStatus.textContent = snrStatusText;
            snrStatus.className = `text-[${snrColor}] font-semibold`;
        }
        
        // Initial call to render icons on page load
        document.addEventListener('DOMContentLoaded', lucide.createIcons);

    </script>

    <!-- Google Maps API Loader -->
    <!-- !!! IMPORTANT !!! Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual key -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap">
    </script>
</body>
</html>